function CanvasTileLayer(a,b){this.tileSize=new google.maps.Size(256,256);this.maxZoom=19;this.name="Tile #s";this.alt="Canvas tile layer";this.tiles={};this.canvas_setup=a;this.render=b;b||(this.render=a)}
CanvasTileLayer.prototype.create_tile_canvas=function(a,b,c){var d=c.createElement("canvas"),c=c.createElement("canvas");d.style.border=c.style.border="none";d.style.margin=c.style.margin="0";d.style.padding=c.style.padding="0";var g=d.getContext("2d");g.width=d.width=this.tileSize.width;g.height=d.height=this.tileSize.height;var f=c.getContext("2d");c.width=f.width=this.tileSize.width;c.height=f.height=this.tileSize.height;var e=a.x+"_"+a.y+"_"+b;d.setAttribute("id",e);c.setAttribute("id",e);e in
this.tiles&&delete this.tiles[e];this.tiles[e]={canvas:d,ctx:g,hit_canvas:c,hit_ctx:f,coord:a,zoom:b,primitives:null};this.canvas_setup&&this.canvas_setup(this.tiles[e],a,b);return d};CanvasTileLayer.prototype.each=function(a){for(var b in this.tiles)a(this.tiles[b])};CanvasTileLayer.prototype.recreate=function(){for(var a in this.tiles){var b=this.tiles[a];this.canvas_setup(b,b.coord,b.zoom)}};CanvasTileLayer.prototype.redraw_tile=function(a){this.render(a,a.coord,a.zoom)};
CanvasTileLayer.prototype.redraw=function(){for(var a in this.tiles){var b=this.tiles[a];this.render(b,b.coord,b.zoom)}};CanvasTileLayer.prototype.getTile=function(a,b,c){return this.create_tile_canvas(a,b,c)};CanvasTileLayer.prototype.releaseTile=function(a){delete this.tiles[a.getAttribute("id")]};function TimePlayer(a,b,c,d){this.time=0;this.step=c;this.CAP_UNIT=b;this.MIN_DATE=a;this.MAX_UNITS=d.steps+2;this.BASE_UNIT=this.MAX_VALUE_LOG=this.MAX_VALUE=0;this.canvas_setup=this.get_time_data;this.render=this.render_time;this.cells=[];this.table=d.table;this.user=d.user;this.t_column=d.column;this.resolution=d.resolution;this.countby=d.countby;this.base_url="http://d2c5ry9dy1ewvi.cloudfront.net/api/v2/sql";this.options=d}TimePlayer.prototype=new CanvasTileLayer;
TimePlayer.prototype.set_time=function(a){this.time!=a>>0&&(this.time=a,this.redraw())};TimePlayer.prototype.reset_max_value=function(){this.MAX_VALUE_LOG=this.MAX_VALUE=0};TimePlayer.prototype.set_table=function(a,b){this.table!==a&&(this.table=a,this.pixel_size=b,this.recreate(),this.redraw())};TimePlayer.prototype.sql=function(a,b){$.getJSON(this.base_url+"?q="+encodeURIComponent(a),function(a){b(a)})};var originShift=12756274*Math.PI/2,initialResolution=12756274*Math.PI/256;
function meterToPixels(a,b,c){c=initialResolution/(1<<c);return[(a+originShift)/c,(b+originShift)/c]}
TimePlayer.prototype.pre_cache_months=function(a,b,c){var d,g,f;if(void 0!==typeof ArrayBuffer)d=new Uint8Array(new ArrayBuffer(a.length)),g=new Uint8Array(new ArrayBuffer(a.length)),f=new Uint8Array(new ArrayBuffer(a.length*this.MAX_UNITS));else{d=[];g=[];f=[];for(var e=0;e<a.length*this.MAX_UNITS;++e)f[e]=0}var l=256<<c;for(e in a){b=a[e];pixels=meterToPixels(b.x,b.y,c);pixels[1]=l-pixels[1];d[e]=pixels[0];g[e]=pixels[1];for(var j=e*this.MAX_UNITS,h=0;h<b.dates.length;++h)f[j+b.dates[h]]=b.vals[h],
b.vals[h]>this.MAX_VALUE&&(this.MAX_VALUE=b.vals[h],this.MAX_VALUE_LOG=Math.log(this.MAX_VALUE));if(this.options.cumulative)for(h=1;h<this.MAX_UNITS;++h)f[j+h]+=f[j+h-1],f[j+h]>this.MAX_VALUE&&(this.MAX_VALUE=f[j+h],this.MAX_VALUE_LOG=Math.log(this.MAX_VALUE))}return{length:a.length,xcoords:d,ycoords:g,values:f,size:1<<2*this.resolution}};
TimePlayer.prototype.get_time_data=function(a,b,c){var d=this;if(d.table){var g="WITH hgrid AS (     SELECT CDB_RectangleGrid( "+"       CDB_XYZ_Extent({0}, {1}, {2}), ".format(b.x,b.y,c)+"       CDB_XYZ_Resolution({0}) * {1}, ".format(c,this.resolution)+"       CDB_XYZ_Resolution({0}) * {1} ".format(c,this.resolution)+"    ) as cell  )  SELECT      x, y, array_agg(c) vals, array_agg(d) dates  FROM (     SELECT       round(CAST (st_xmax(hgrid.cell) AS numeric),4) x, round(CAST (st_ymax(hgrid.cell) AS numeric),4) y, "+
"      {0} c, floor((date_part('epoch',{1})- {2})/{3}) d ".format(this.countby,this.t_column,this.MIN_DATE,this.step)+"    FROM "+"        hgrid, {0} i ".format(this.table)+"    WHERE         ST_Intersects(i.the_geom_webmercator, hgrid.cell)     GROUP BY "+"        hgrid.cell, floor((date_part('epoch',{0})- {1})/{2})".format(this.t_column,this.MIN_DATE,this.step)+" ) f GROUP BY x, y",f=Profiler.get("tile fetch");f.start();this.sql(g,function(e){if(e.rows){f.end();var g=Profiler.get("tile data cache");
g.start();a.cells=d.pre_cache_months(e.rows,b,c);g.end();g=Profiler.get("tile render");g.start();d.redraw_tile(a);g.end()}})}};YO=1;
TimePlayer.prototype.render_time=function(a,b,c){var d=this,b=this.time,g=a.canvas.width,f=a.ctx,e,l;if((l=a.cells)&&0!==l.length){var j="#FEE391,#FEC44F,#FE9929,#EC7014,#CC4C02,#993404,#662506".split(",");a.canvas.width=g;a=e=0;f.strokeStyle=f.fillStyle=j[a];f.globalCompositeOperation=this.options.blendmode;var g=l.xcoords,h=l.ycoords;Math.pow(2,c);var q=l.length,i=this.resolution,n=2*i,o=1.5*i,m=Math.floor((i-1)/2),p=2*Math.PI;void 0==d.sprite_1&&(d.sprite_1=[],$(j).each(function(){var a=document.createElement("canvas"),
b=a.getContext("2d");b.width=a.width=2*i;b.height=a.height=2*i;b.globalAlpha=1;b.fillStyle=this.toString();b.beginPath();b.arc(i,i,i,0,p,!0,!0);b.closePath();b.fill();d.sprite_1.push(a)}));void 0==d.sprite_2&&(d.sprite_2=[],$(j).each(function(){var a=document.createElement("canvas"),b=a.getContext("2d");b.width=a.width=n*2;b.height=a.height=n*2;b.globalAlpha=0.3;b.fillStyle=this.toString();b.beginPath();b.arc(n,n,n,0,p,true,true);b.closePath();b.fill();d.sprite_2.push(a)}));void 0==d.sprite_3&&(d.sprite_3=
[],$(j).each(function(){var a=document.createElement("canvas"),b=a.getContext("2d");b.width=a.width=i*2;b.height=a.height=i*2;b.globalAlpha=0.3;b.fillStyle=this.toString();b.beginPath();b.arc(i,i,i,0,p,true,true);b.closePath();b.fill();d.sprite_3.push(a)}));for(c=0;c<q;++c){if(e=l.values[this.MAX_UNITS*c+b])e=0==e?0:Math.floor((j.length-1)*(Math.log(e)/this.MAX_VALUE_LOG)),e!=a&&(a=e<j.length?e:a,f.fillStyle=j[a]),"circle"==this.options.point_type?f.drawImage(d.sprite_1[a],g[c]-i,h[c]-i):"square"==
this.options.point_type&&f.fillRect(g[c]-m,h[c]-m,i,i);if(!0==this.options.trails){if(e=l.values[this.MAX_UNITS*c+b-1])e=0==e?0:Math.floor((j.length-1)*(Math.log(e)/this.MAX_VALUE_LOG)),e!=a&&(a=e<j.length?e:a,f.fillStyle=j[a]),"circle"==this.options.point_type?f.drawImage(d.sprite_2[a],g[c]-o-1,h[c]-o-1):"square"==this.options.point_type&&f.fillRect(g[c]-m,h[c]-m,o,o);if(e=l.values[this.MAX_UNITS*c+b-2])e=0==e?0:Math.floor((j.length-1)*(Math.log(e)/this.MAX_VALUE_LOG)),e!=a&&(a=e<j.length?e:a,f.fillStyle=
j[a]),"circle"==this.options.point_type?f.drawImage(d.sprite_3[a],g[c]-i,h[c]-i):"square"==this.options.point_type&&f.fillRect(g[c]-m,h[c]-m,i,i)}}}};String.prototype.format=function(a,b,c){return function(){var d=this,g=arguments.length+1;for(a=0;a<g;c=arguments[a++])b="object"===typeof c?JSON.stringify(c):c,d=d.replace(RegExp("\\{"+(a-1)+"\\}","g"),b);return d}}();function Profiler(){}Profiler.times={};
Profiler.new_time=function(a,b){var c=Profiler.times[a]=Profiler.times[a]||{max:0,min:1E7,avg:0,total:0,count:0};c.max=Math.max(c.max,b);c.total+=b;c.min=Math.min(c.min,b);++c.count;c.avg=c.total/c.count};Profiler.print_stats=function(){for(k in Profiler.times){var a=Profiler.times[k];console.log(" === "+k+" === ");console.log(" max: "+a.max);console.log(" min: "+a.min);console.log(" avg: "+a.avg);console.log(" total: "+a.total)}};
Profiler.get=function(a){return{t0:null,start:function(){this.t0=(new Date).getTime()},end:function(){null!==this.t0&&(Profiler.new_time(a,this.time=(new Date).getTime()-this.t0),this.t0=null)}}};function Torque(){var a=Array.prototype.slice.call(arguments),b=a.pop(),a=a[0]&&"string"===typeof a[0]?a:a[0],c;if(!(this instanceof Torque))return new Torque(a,b);if(!a||"*"===a)for(c in a=[],Torque.modules)Torque.modules.hasOwnProperty(c)&&a.push(c);for(c=0;c<a.length;c+=1)Torque.modules[a[c]](this);b(this);return this}Torque.modules={};
Torque.modules.app=function(a){a.app={};a.app.Instance=Class.extend({init:function(b){this.layers={};a.log.enabled=b?b:!1},addLayer:function(b,c){return new a.layer.Engine(b,c)}})};
Torque.modules.layer=function(a){a.layer={};a.layer.Engine=Class.extend({init:function(b,c){this._defaults={user:"viz2",table:"ny_bus",column:"timestamp",steps:250,resolution:3,cumulative:!1,fps:24,autoplay:!0,clock:!1,zindex:0,fitbounds:!1,countby:"count(i.cartodb_id)",blendmode:"source-over",trails:!1,point_type:"square"};this.options=_.defaults(c,this._defaults);this._map=b;for(this._index=this.options.zindex;this._map.overlayMapTypes.length<this.options.zindex;)this._map.overlayMapTypes.push(null);
this._cartodb=new Backbone.CartoDB({user:this.options.user});this.bounds=new google.maps.LatLngBounds;a.clock.enabled=this.options.clock?this.options.clock:!1;a.clock.set('<span class="loading">loading...</span>');this.getDeltas()},pause:function(){!0==this.running?this.running=!1:(this.running=!0,this.play())},setOptions:function(b){this.running=!1;this.options=_.defaults(b,this._defaults);a.clock.enabled=this.options.clock?this.options.clock:!1;a.clock.set('<span class="loading">loading...</span>');
this._cartodb=new Backbone.CartoDB({user:this.options.user});this.bounds=new google.maps.LatLngBounds;this._map.overlayMapTypes.setAt(this._index,null);this.getDeltas()},run:function(){this.start=(new Date(this.options.start)).getTime();this.end=(new Date(this.options.end)).getTime();this._current=this.start;this._step=Math.floor((this.end-this.start)/this.options.steps);this._setupListeners();this._display=new TimePlayer(this.start,this.start-this.end,this._step,this.options);this._map.overlayMapTypes.setAt(this._index,
this._display);this.fitBounds(this.options.fitbounds);this.running=!1;a.clock.clear();this.options.autoplay&&(this.running=!0,this.play());a.log.info("Layer is now running!")},_setupListeners:function(){var a=this;google.maps.event.addListener(this._map,"zoom_changed",function(){a._display.reset_max_value()})},getBounds:function(){return this.bounds},fitBounds:function(a){!1!==a&&(this._map.fitBounds(this.bounds),"number"==typeof a?this._map.setZoom(this._map.getZoom()+a):this._map.setZoom(this._map.getZoom()))},
getDeltas:function(){var a=this,c=new (this._cartodb.CartoDBCollection.extend({sql:"SELECT st_xmax(st_envelope(st_collect(the_geom))) xmax,st_ymax(st_envelope(st_collect(the_geom))) ymax, st_xmin(st_envelope(st_collect(the_geom))) xmin, st_ymin(st_envelope(st_collect(the_geom))) ymin, date_part('epoch',max({0})) max, date_part('epoch',min({0})) min FROM {1}".format(this.options.column,this.options.table)}));c.fetch();c.bind("reset",function(){c.each(function(c){a.options.start=c.get("min");a.options.end=
c.get("max");a.bounds.extend(new google.maps.LatLng(c.get("ymin"),c.get("xmax")));a.bounds.extend(new google.maps.LatLng(c.get("ymax"),c.get("xmin")));a.bounds.extend(new google.maps.LatLng((c.get("ymax")+c.get("ymin"))/2,(c.get("xmax")+c.get("xmin"))/2))});a.run()})},advance:function(){this._current=this._current<this.end?this._current+this._step:this.start;this._display.set_time((this._current-this.start)/this._step)},play:function(){var b=0;this._current<this.end?(this._current+=this._step,this.end<
this._current&&(b=2500)):this._current=this.start;var c=new Date(1E3*this._current),d=c.toString().substr(4).split(" ");a.clock.set('<span id="ow_month">'+d[0]+'</span> <span id="ow_year">'+d[2]+"</span>");a.subtitles.set(c);this._display.set_time((this._current-this.start)/this._step);this.running&&setTimeout(function(){this.play()}.bind(this),b+1E3/this.options.fps)}})};
Torque.modules.clock=function(a){a.clock={};a.clock.clear=function(){$(".torque_time").html("")};a.clock.set=function(b){a.clock._hand(b)};a.clock._hand=function(b){a.clock.enabled&&$(".torque_time").html(b)}};
Torque.modules.subtitles=function(a){a.subtitles={subs:[{from:new Date("March 01, 1913 00:00:00"),to:new Date("July 01, 1914 00:00:00"),sub:"Pre war"},{from:new Date("August 01, 1914 00:00:00"),to:new Date("February 01, 1915 00:00:00"),sub:"War begins with Germany"},{from:new Date("February 02, 1915 00:00:00"),to:new Date("October 01, 1916 00:00:00"),sub:"North Sea naval blockade"},{from:new Date("October 02, 1917 00:00:00"),to:new Date("April 01, 1917 00:00:00"),sub:"Atlantic U-boat warfare"},{from:new Date("April 02, 1917 00:00:00"),
to:new Date("September 01, 1917 00:00:00"),sub:"USA enters war"},{from:new Date("September 02, 1917 00:00:00"),to:new Date("November 01, 1918 00:00:00"),sub:"Destroyers begin to escort convoys in Atlantic"},{from:new Date("November 02, 1918 00:00:00"),to:new Date("August 01, 1920 00:00:00"),sub:"End of WWI"},{from:new Date("August 02, 1920 00:00:00"),to:new Date("August 01, 1925 00:00:00"),sub:"Trade routes resume"}]};a.subtitles.clear=function(){$(".torque_subs").html("")};a.subtitles.set=function(b){$.each(this.subs,
function(){this.from<b&&this.to>b&&a.subtitles._update(this.sub)})};a.subtitles._update=function(a){$(".torque_subs").html(a)}};Torque.modules.log=function(a){a.log={};a.log.info=function(b){a.log._torquete("INFO: "+b)};a.log.warn=function(b){a.log._torquete("WARN: "+b)};a.log.error=function(b){a.log._torquete("ERROR: "+b)};a.log.todo=function(b){a.log._torquete("TODO: "+b)};a.log._torquete=function(b){var c=window.console;a.log.enabled&&(c&&c.markTimeline&&c.markTimeline(b),console.log(b))}};
originShift=12756274*Math.PI/2;initialResolution=12756274*Math.PI/256;function meterToPixels(a,b,c){c=initialResolution/(1<<c);return[(a+originShift)/c,(b+originShift)/c]};
