function CanvasTileLayer(e,t){this.tileSize=new google.maps.Size(256,256),this.maxZoom=19,this.name="Tile #s",this.alt="Canvas tile layer",this.tiles={},this.canvas_setup=e,this.render=t,t||(this.render=e)}function TimePlayer(e,t,n,r){this.time=0,this.step=n,this.CAP_UNIT=t,this.MIN_DATE=e,this.MAX_UNITS=r.steps+2,this.MAX_VALUE=0,this.MAX_VALUE_LOG=0,this.BASE_UNIT=0,this.canvas_setup=this.get_time_data,this.render=this.render_time,this.cells=[],this.table=r.table,this.user=r.user,this.t_column=r.column,this.resolution=r.resolution,this.countby=r.countby,this.base_url="http://d2c5ry9dy1ewvi.cloudfront.net/api/v2/sql",this.options=r}function meterToPixels(e,t,n){var r=initialResolution/(1<<n),i=(e+originShift)/r,s=(t+originShift)/r;return[i,s]}function Profiler(){}function Torque(){var e=Array.prototype.slice.call(arguments),t=e.pop(),n=e[0]&&typeof e[0]=="string"?e:e[0],r,i;if(this instanceof Torque){if(!n||n==="*"){n=[];for(i in Torque.modules)Torque.modules.hasOwnProperty(i)&&n.push(i)}for(i=0;i<n.length;i+=1)Torque.modules[n[i]](this);return t(this),this}return new Torque(n,t)}function meterToPixels(e,t,n){var r=initialResolution/(1<<n),i=(e+originShift)/r,s=(t+originShift)/r;return[i,s]}CanvasTileLayer.prototype.create_tile_canvas=function(e,t,n){var r=n.createElement("canvas"),i=n.createElement("canvas");r.style.border=i.style.border="none",r.style.margin=i.style.margin="0",r.style.padding=i.style.padding="0";var s=r.getContext("2d");s.width=r.width=this.tileSize.width,s.height=r.height=this.tileSize.height;var o=i.getContext("2d");i.width=o.width=this.tileSize.width,i.height=o.height=this.tileSize.height;var u=e.x+"_"+e.y+"_"+t;return r.setAttribute("id",u),i.setAttribute("id",u),u in this.tiles&&delete this.tiles[u],this.tiles[u]={canvas:r,ctx:s,hit_canvas:i,hit_ctx:o,coord:e,zoom:t,primitives:null},this.canvas_setup&&this.canvas_setup(this.tiles[u],e,t),r},CanvasTileLayer.prototype.each=function(e){for(var t in this.tiles){var n=this.tiles[t];e(n)}},CanvasTileLayer.prototype.recreate=function(){for(var e in this.tiles){var t=this.tiles[e];this.canvas_setup(t,t.coord,t.zoom)}},CanvasTileLayer.prototype.redraw_tile=function(e){this.render(e,e.coord,e.zoom)},CanvasTileLayer.prototype.redraw=function(){for(var e in this.tiles){var t=this.tiles[e];this.render(t,t.coord,t.zoom)}},CanvasTileLayer.prototype.getTile=function(e,t,n){return this.create_tile_canvas(e,t,n)},CanvasTileLayer.prototype.releaseTile=function(e){var t=e.getAttribute("id");delete this.tiles[t]},TimePlayer.prototype=new CanvasTileLayer,TimePlayer.prototype.set_time=function(e){this.time!=e>>0&&(this.time=e,this.redraw())},TimePlayer.prototype.reset_max_value=function(){this.MAX_VALUE=0,this.MAX_VALUE_LOG=0},TimePlayer.prototype.set_table=function(e,t){if(this.table===e)return;this.table=e,this.pixel_size=t,this.recreate(),this.redraw()},TimePlayer.prototype.sql=function(e,t){var n=this;$.getJSON(this.base_url+"?q="+encodeURIComponent(e),function(e){t(e)})};var originShift=2*Math.PI*6378137/2,initialResolution=2*Math.PI*6378137/256;TimePlayer.prototype.pre_cache_months=function(e,t,n){var r,i,s,o;if(typeof ArrayBuffer!==undefined)i=new Uint8Array(new ArrayBuffer(e.length)),s=new Uint8Array(new ArrayBuffer(e.length)),o=new Uint8Array(new ArrayBuffer(e.length*this.MAX_UNITS));else{i=[],s=[],o=[];for(var u=0;u<e.length*this.MAX_UNITS;++u)o[u]=0}var a=t.x*256,f=t.y*256,l=256<<n;for(var u in e){r=e[u],pixels=meterToPixels(r.x,r.y,n),pixels[1]=l-pixels[1],i[u]=pixels[0],s[u]=pixels[1];var c=u*this.MAX_UNITS;for(var h=0;h<r.dates.length;++h)o[c+r.dates[h]]=r.vals[h],r.vals[h]>this.MAX_VALUE&&(this.MAX_VALUE=r.vals[h],this.MAX_VALUE_LOG=Math.log(this.MAX_VALUE));if(this.options.cumulative)for(var h=1;h<this.MAX_UNITS;++h)o[c+h]+=o[c+h-1],o[c+h]>this.MAX_VALUE&&(this.MAX_VALUE=o[c+h],this.MAX_VALUE_LOG=Math.log(this.MAX_VALUE))}return{length:e.length,xcoords:i,ycoords:s,values:o,size:1<<this.resolution*2}},TimePlayer.prototype.get_time_data=function(e,t,n){var r=this;if(!r.table)return;var i=1<<n,s="WITH hgrid AS (     SELECT CDB_RectangleGrid( "+"       CDB_XYZ_Extent({0}, {1}, {2}), ".format(t.x,t.y,n)+"       CDB_XYZ_Resolution({0}) * {1}, ".format(n,this.resolution)+"       CDB_XYZ_Resolution({0}) * {1} ".format(n,this.resolution)+"    ) as cell "+" ) "+" SELECT  "+"    x, y, array_agg(c) vals, array_agg(d) dates "+" FROM ( "+"    SELECT "+"      round(CAST (st_xmax(hgrid.cell) AS numeric),4) x, round(CAST (st_ymax(hgrid.cell) AS numeric),4) y, "+"      {0} c, floor((date_part('epoch',{1})- {2})/{3}) d ".format(this.countby,this.t_column,this.MIN_DATE,this.step)+"    FROM "+"        hgrid, {0} i ".format(this.table)+"    WHERE "+"        ST_Intersects(i.the_geom_webmercator, hgrid.cell) "+"    GROUP BY "+"        hgrid.cell, floor((date_part('epoch',{0})- {1})/{2})".format(this.t_column,this.MIN_DATE,this.step)+" ) f GROUP BY x, y",o=Profiler.get("tile fetch");o.start(),this.sql(s,function(i){if(i.rows){o.end();var s=Profiler.get("tile data cache");s.start(),e.cells=r.pre_cache_months(i.rows,t,n),s.end(),s=Profiler.get("tile render"),s.start(),r.redraw_tile(e),s.end()}})},YO=1,TimePlayer.prototype.render_time=function(e,t,n){var r=this,i=this.time,s=e.canvas.width,o=e.canvas.height,u=e.ctx,a,f,l,c,h;h=e.cells;if(!h||h.length===0)return;var p=["#FEE391","#FEC44F","#FE9929","#EC7014","#CC4C02","#993404","#662506"],d;e.canvas.width=s;var v=0,m=0;u.strokeStyle=u.fillStyle=p[m],u.globalCompositeOperation=this.options.blendmode;var g=h.xcoords,y=h.ycoords,b=h.values,w=256/Math.pow(2,n),E=h.length,S=this.resolution,x=S*2,T=S*1.5,N=Math.floor((S-1)/2),C=Math.PI*2;r.sprite_1==undefined&&(r.sprite_1=[],$(p).each(function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.width=e.width=S*2,t.height=e.height=S*2,t.globalAlpha=1,t.fillStyle=this.toString(),t.beginPath(),t.arc(S,S,S,0,C,!0,!0),t.closePath(),t.fill(),r.sprite_1.push(e)})),r.sprite_2==undefined&&(r.sprite_2=[],$(p).each(function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.width=e.width=x*2,t.height=e.height=x*2,t.globalAlpha=.3,t.fillStyle=this.toString(),t.beginPath(),t.arc(x,x,x,0,C,!0,!0),t.closePath(),t.fill(),r.sprite_2.push(e)})),r.sprite_3==undefined&&(r.sprite_3=[],$(p).each(function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.width=e.width=S*2,t.height=e.height=S*2,t.globalAlpha=.3,t.fillStyle=this.toString(),t.beginPath(),t.arc(S,S,S,0,C,!0,!0),t.closePath(),t.fill(),r.sprite_3.push(e)}));var k=1<<n;for(a=0;a<E;++a){var c=h.values[this.MAX_UNITS*a+i];c&&(v=c==0?0:Math.floor((p.length-1)*(Math.log(c)/this.MAX_VALUE_LOG)),v!=m&&(m=v<p.length?v:m,u.fillStyle=p[m]),this.options.point_type=="circle"?u.drawImage(r.sprite_1[m],g[a]-S,y[a]-S):this.options.point_type=="square"&&u.fillRect(g[a]-N,y[a]-N,S,S)),this.options.trails==1&&(c=h.values[this.MAX_UNITS*a+i-1],c&&(v=c==0?0:Math.floor((p.length-1)*(Math.log(c)/this.MAX_VALUE_LOG)),v!=m&&(m=v<p.length?v:m,u.fillStyle=p[m]),this.options.point_type=="circle"?u.drawImage(r.sprite_2[m],g[a]-T-1,y[a]-T-1):this.options.point_type=="square"&&u.fillRect(g[a]-N,y[a]-N,T,T)),c=h.values[this.MAX_UNITS*a+i-2],c&&(v=c==0?0:Math.floor((p.length-1)*(Math.log(c)/this.MAX_VALUE_LOG)),v!=m&&(m=v<p.length?v:m,u.fillStyle=p[m]),this.options.point_type=="circle"?u.drawImage(r.sprite_3[m],g[a]-S,y[a]-S):this.options.point_type=="square"&&u.fillRect(g[a]-N,y[a]-N,S,S)))}},String.prototype.format=function(e,t,n){function r(){var r=this,s=arguments.length+1;for(e=0;e<s;n=arguments[e++])t=typeof n=="object"?JSON.stringify(n):n,r=r.replace(RegExp("\\{"+(e-1)+"\\}","g"),t);return r}return r.native=String.prototype.format,r}(),Profiler.times={},Profiler.new_time=function(e,t){var n=Profiler.times[e]=Profiler.times[e]||{max:0,min:1e7,avg:0,total:0,count:0};n.max=Math.max(n.max,t),n.total+=t,n.min=Math.min(n.min,t),++n.count,n.avg=n.total/n.count},Profiler.print_stats=function(){for(k in Profiler.times){var e=Profiler.times[k];console.log(" === "+k+" === "),console.log(" max: "+e.max),console.log(" min: "+e.min),console.log(" avg: "+e.avg),console.log(" total: "+e.total)}},Profiler.get=function(e){return{t0:null,start:function(){this.t0=(new Date).getTime()},end:function(){this.t0!==null&&(Profiler.new_time(e,this.time=(new Date).getTime()-this.t0),this.t0=null)}}},Torque.modules={},Torque.modules.app=function(e){e.app={},e.app.Instance=Class.extend({init:function(t){this.layers={},e.log.enabled=t?t:!1},addLayer:function(t,n){var r=new e.layer.Engine(t,n);return r}})},Torque.modules.layer=function(e){e.layer={},e.layer.Engine=Class.extend({init:function(t,n){this._defaults={user:"viz2",table:"ny_bus",column:"timestamp",steps:250,resolution:3,cumulative:!1,fps:24,autoplay:!0,clock:!1,zindex:0,fitbounds:!1,countby:"count(i.cartodb_id)",blendmode:"source-over",trails:!1,point_type:"square"},this.options=_.defaults(n,this._defaults),this._map=t,this._index=this.options.zindex;while(this._map.overlayMapTypes.length<this.options.zindex)this._map.overlayMapTypes.push(null);this._cartodb=new Backbone.CartoDB({user:this.options.user}),this.bounds=new google.maps.LatLngBounds,e.clock.enabled=this.options.clock?this.options.clock:!1,e.clock.set("loading..."),this.getDeltas()},pause:function(){this.running==1?this.running=!1:(this.running=!0,this.play())},setOptions:function(t){this.running=!1,this.options=_.defaults(t,this._defaults),e.clock.enabled=this.options.clock?this.options.clock:!1,e.clock.set("loading..."),this._cartodb=new Backbone.CartoDB({user:this.options.user}),this.bounds=new google.maps.LatLngBounds,this._map.overlayMapTypes.setAt(this._index,null),this.getDeltas()},run:function(){this.start=(new Date(this.options.start)).getTime(),this.end=(new Date(this.options.end)).getTime(),this._current=this.start,this._step=Math.floor((this.end-this.start)/this.options.steps),this._setupListeners(),this._display=new TimePlayer(this.start,this.start-this.end,this._step,this.options),this._map.overlayMapTypes.setAt(this._index,this._display),this.fitBounds(this.options.fitbounds),this.running=!1,e.clock.clear(),this.options.autoplay&&(this.running=!0,this.play()),e.log.info("Layer is now running!")},_setupListeners:function(){var e=this;google.maps.event.addListener(this._map,"zoom_changed",function(){e._display.reset_max_value()})},getBounds:function(){return this.bounds},fitBounds:function(e){e!==!1&&(this._map.fitBounds(this.bounds),typeof e=="number"?this._map.setZoom(this._map.getZoom()+e):this._map.setZoom(this._map.getZoom()))},getDeltas:function(e){var t=this,n="SELECT st_xmax(st_envelope(st_collect(the_geom))) xmax,st_ymax(st_envelope(st_collect(the_geom))) ymax, st_xmin(st_envelope(st_collect(the_geom))) xmin, st_ymin(st_envelope(st_collect(the_geom))) ymin, date_part('epoch',max({0})) max, date_part('epoch',min({0})) min FROM {1}".format(this.options.column,this.options.table),r=this._cartodb.CartoDBCollection.extend({sql:n}),i=new r;i.fetch(),i.bind("reset",function(){i.each(function(e){t.options.start=e.get("min"),t.options.end=e.get("max"),t.bounds.extend(new google.maps.LatLng(e.get("ymin"),e.get("xmax"))),t.bounds.extend(new google.maps.LatLng(e.get("ymax"),e.get("xmin"))),t.bounds.extend(new google.maps.LatLng((e.get("ymax")+e.get("ymin"))/2,(e.get("xmax")+e.get("xmin"))/2))}),t.run()})},advance:function(){this._current<this.end?this._current=this._current+this._step:this._current=this.start,this._display.set_time((this._current-this.start)/this._step)},play:function(){var t=0;this._current<this.end?(this._current=this._current+this._step,this.end<this._current&&(t=2500)):this._current=this.start;var n=new Date(this._current*1e3),r=n.toString().substr(4).split(" ");e.clock.set('<span id="ow_month">'+r[0]+'</span> <span id="ow_year">'+r[2]+"</span>"),e.subtitles.set(n),this._display.set_time((this._current-this.start)/this._step),this.running&&setTimeout(function(){this.play()}.bind(this),t+1e3/this.options.fps)}})},Torque.modules.clock=function(e){e.clock={},e.clock.clear=function(){$(".torque_time").html("")},e.clock.set=function(t){e.clock._hand(t)},e.clock._hand=function(t){var n=window.console;e.clock.enabled&&$(".torque_time").html(t)}},Torque.modules.subtitles=function(e){e.subtitles={subs:[{from:new Date("March 01, 1913 00:00:00"),to:new Date("July 01, 1914 00:00:00"),sub:"Pre WW1"},{from:new Date("August 01, 1914 00:00:00"),to:new Date("February 01, 1915 00:00:00"),sub:"WW1: War begins with Germany"},{from:new Date("February 02, 1915 00:00:00"),to:new Date("June 01, 1916 00:00:00"),sub:"WW1: North Sea blockade"},{from:new Date("June 02, 1916 00:00:00"),to:new Date("November 01, 1916 00:00:00"),sub:"WW1: Cape Verde"},{from:new Date("November 02, 1917 00:00:00"),to:new Date("April 01, 1917 00:00:00"),sub:"WW1: Atlantic Submarine warfare"},{from:new Date("April 02, 1917 00:00:00"),to:new Date("August 01, 1917 00:00:00"),sub:"WW1: USA enters WW1"},{from:new Date("August 02, 1917 00:00:00"),to:new Date("February 01, 1918 00:00:00"),sub:"WW1: Destroyers begin to escort convoys in Atlantic"},{from:new Date("February 02, 1918 00:00:00"),to:new Date("November 01, 1918 00:00:00"),sub:"WW1: Southern Hemisphere convoys from Dakar"},{from:new Date("November 02, 1918 00:00:00"),to:new Date("July 01, 1919 00:00:00"),sub:"WW1: End of WW1"},{from:new Date("July 02, 1919 00:00:00"),to:new Date("August 01, 1920 00:00:00"),sub:"Suez canal trade route"},{from:new Date("August 02, 1920 00:00:00"),to:new Date("August 01, 1925 00:00:00"),sub:"Asian diplomacy & Yangtze river convoys"}]},e.subtitles.clear=function(){$(".torque_subs").html("")},e.subtitles.set=function(t){$.each(this.subs,function(){this.from<t&&this.to>t&&e.subtitles._update(this.sub)})},e.subtitles._update=function(e){$(".torque_subs").html(e)}},Torque.modules.log=function(e){e.log={},e.log.info=function(t){e.log._torquete("INFO: "+t)},e.log.warn=function(t){e.log._torquete("WARN: "+t)},e.log.error=function(t){e.log._torquete("ERROR: "+t)},e.log.todo=function(t){e.log._torquete("TODO: "+t)},e.log._torquete=function(t){var n=window.console;e.log.enabled&&(n&&n.markTimeline&&n.markTimeline(t),console.log(t))}};var originShift=2*Math.PI*6378137/2,initialResolution=2*Math.PI*6378137/256;